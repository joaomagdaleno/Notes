name: Quality Gate

on:
  workflow_call:
    # Se quiser, pode passar inputs para o workflow, como o n√≠vel m√≠nimo de cobertura
    inputs:
      min_coverage:
        description: 'Minimum code coverage percentage'
        required: false
        default: '80'
        type: string

# Adicione um bloco de permiss√µes no n√≠vel do job para permitir a escrita no GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0 # Necess√°rio para o git history em alguns casos

      - name: Install Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          flutter-version: '3.38.2' # Verifique se esta vers√£o √© a correta (3.19.x √© a mais recente est√°vel)
          cache: true

      - name: Flutter Pub Get
        working-directory: universal_notes_flutter
        run: flutter pub get

      - name: Run Flutter Analyzer
        working-directory: universal_notes_flutter
        run: flutter analyze

      - name: Check for Outdated Packages
        working-directory: universal_notes_flutter
        run: dart pub outdated

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@df31a0e53a1efa49f2396699d51254455bb81868 # main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Tests
        working-directory: universal_notes_flutter
        run: flutter test --coverage

      - name: Generate HTML coverage report
        working-directory: universal_notes_flutter
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          genhtml coverage/lcov.info -o coverage/html

      # Este step de upload de artefato ainda √© √∫til como backup
      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-pr-${{ github.event.number }}
          path: universal_notes_flutter/coverage/html
          retention-days: 15 # Mant√©m o artefato por 15 dias

      # Este step pode ser removido, pois o link para o HTML √© muito melhor
      # - name: Show coverage report
      #   run: |
      #     echo "--- Coverage Report (lcov.info) ---"
      #     cat universal_notes_flutter/coverage/lcov.info
      #     echo "-------------------------------------"

      - name: Calculate code coverage
        id: coverage
        run: |
          HIT=$(grep "^LH:" universal_notes_flutter/coverage/lcov.info | awk '{s+=$2} END {print s}' FS=":")
          FOUND=$(grep "^LF:" universal_notes_flutter/coverage/lcov.info | awk '{s+=$2} END {print s}' FS=":")
          if [ "$FOUND" -eq 0 ]; then
            COVERAGE="0.0"
          else
            COVERAGE=$(echo "scale=2; 100 * $HIT / $FOUND" | bc)
          fi
          echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT

      # === NOVO STEP DEPLOY PARA O GITHUB PAGES ===
      - name: Deploy coverage report to GitHub Pages
        # Este step s√≥ ser√° executado em Pull Requests
        if: github.event_name == 'pull_request'
        uses: peaceiris/actions-gh-pages@v3
        with:
          # O GITHUB_TOKEN √© gerado automaticamente e com as permiss√µes que definimos acima, ele funciona.
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # O diret√≥rio onde seu relat√≥rio HTML foi gerado
          publish_dir: ./universal_notes_flutter/coverage/html
          # Cria uma pasta √∫nica para cada Pull Request para evitar conflitos
          destination_dir: pr-${{ github.event.number }}

      # === STEP ATUALIZADO PARA POSTAR O COMENT√ÅRIO COM O LINK ===
      - name: Post coverage comment
        # Usa a action para postar/editar um coment√°rio "sticky" na PR
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          # Constr√≥i a mensagem com a porcentagem e o link para o relat√≥rio
          message: |
            üìä **Code Coverage:** `${{ steps.coverage.outputs.percentage }}%`

            üìà **[Ver relat√≥rio de cobertura detalhado](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${{ github.event.number }}/)**

            _Este relat√≥rio √© atualizado a cada novo commit na Pull Request._
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check code coverage
        run: |
          # Usa o valor do input ou o padr√£o 80
          MIN_COVERAGE=${{ inputs.min_coverage }}
          COVERAGE_PERCENTAGE=$(echo "${{ steps.coverage.outputs.percentage }}" | awk '{print int($1)}')
          if (( COVERAGE_PERCENTAGE < MIN_COVERAGE )); then
            echo "Error: Code coverage is ${{ steps.coverage.outputs.percentage }}%, which is below the required minimum of ${MIN_COVERAGE}%."
            exit 1
          fi
