name: Quality Gate
permissions:
  contents: read

on:
  workflow_call:
    inputs:
      min_coverage:
        description: 'Minimum code coverage percentage'
        required: false
        default: '80'
        type: string

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Check changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'Notes-Hub/lib/**'
              - 'Notes-Hub/test/**'
              - 'Notes-Hub/pubspec.yaml'
              - '.github/workflows/**'
              - 'scripts/**'
            docs:
              - '**.md'
              - 'docs/**'
              - '**.txt'
            ci:
              - '.github/workflows/**'
              - 'scripts/**'
              - 'toolchain.lock.json'

  static-analysis:
    name: Static Analysis
    needs: check-changes
    if: needs.check-changes.outputs.code == 'true' || needs.check-changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          cache: true
          cache-key: 'flutter-3.38.6'
          cache-dependency-path: |
            Notes-Hub/pubspec.lock
            Notes-Hub/**/pubspec.yaml
      - name: Flutter Pub Get
        working-directory: Notes-Hub
        run: flutter pub get
      - name: Check Formatting
        working-directory: Notes-Hub
        run: dart format --output=none --set-exit-if-changed .
      - name: Parallel Audit Suite
        run: dart scripts/run_parallel_audits.dart
      - name: Generate CI Map
        run: dart scripts/generate_governance_manifest.dart
      - name: Generate Release Notes
        run: dart scripts/generate_release_notes.dart
      - name: Run Flutter Analyzer
        working-directory: Notes-Hub
        run: flutter analyze --no-fatal-infos
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@v3.82.2
      - name: OSV Vulnerability Scan
        uses: google/osv-scanner-action@v1
        with:
          args: -r --skip-git ./Notes-Hub
      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: analysis-results
          path: |
            license_audit.txt
            dependency_updates.md
            CI_MAP.md
            complexity_report.json
          retention-days: 1

  functional-tests:
    name: Functional Tests
    needs: check-changes
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.6'
          cache: true
          cache-key: 'flutter-3.38.6'
          cache-dependency-path: |
            Notes-Hub/pubspec.lock
            Notes-Hub/**/pubspec.yaml
      - name: Flutter Pub Get
        working-directory: Notes-Hub
        run: flutter pub get
      - name: Cache build_runner
        uses: actions/cache@v5
        with:
          path: Notes-Hub/.dart_tool/build
          key: ${{ runner.os }}-build-runner-${{ hashFiles('Notes-Hub/pubspec.lock') }}
      - name: Generate Mocks
        working-directory: Notes-Hub
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Run Tests
        working-directory: Notes-Hub
        run: flutter test --coverage --concurrency=4 --test-randomize-ordering-seed=random
      - name: Calculate coverage
        run: dart scripts/calculate_coverage.dart Notes-Hub/coverage/lcov.info ${{ inputs.min_coverage }}
      - name: Upload lcov artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-lcov
          path: Notes-Hub/coverage/lcov.info
          retention-days: 1
      - name: Sync Coverage to Vault
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/beta' || github.ref == 'refs/heads/teste-notes')
        working-directory: Notes-Hub
        run: dart ../scripts/hermes.dart sync push

  report-results:
    name: Report Results
    needs: [static-analysis, functional-tests]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
      - name: Download Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
      - name: Download coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: Notes-Hub/coverage
      - name: Checkout Vault (for Global Dashboard)
        if: github.ref == 'refs/heads/dev'
        uses: actions/checkout@v6
        with:
          ref: coverage-data
          path: hermes_vault
          clean: false

      - name: Sync Coverage Baseline
        run: dart scripts/hermes.dart sync pull ${{ github.base_ref || github.ref }}

      - name: Generate PR Summary
        run: |
          dart scripts/hermes.dart delta
          dart scripts/calculate_impact_score.dart
          dart scripts/generate_pr_summary.dart
      
      - name: Generate Badges & Dashboard
        run: dart scripts/hermes.dart badge

      - name: Collect Pulse Metrics
        run: dart scripts/collect_metrics.dart
      - name: Dependency Weight Analysis
        run: dart scripts/calculate_dependency_weight.dart
      - name: Generate Health Dashboard
        run: dart scripts/generate_health_dashboard.dart
      - name: Generate Visual Telemetry
        run: dart scripts/generate_visual_telemetry.dart
      - name: Upload Health Dashboard
        uses: actions/upload-artifact@v6
        with:
          name: hermes-health-pulse
          path: |
            hermes_health.html
            VISUAL_TELEMETRY.md
            RELEASE_NOTES.md
            GOVERNANCE_MANIFEST.md
            LICENSE_COMPLIANCE.md
            GLOBAL_METRICS.md
            coverage_badge.svg
      - name: Post PR Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pr_summary.md
