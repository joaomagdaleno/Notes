name: Quality Gate

on:
  workflow_call:
    inputs:
      min_coverage:
        description: 'Minimum code coverage percentage'
        required: false
        default: '80'
        type: string

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'Notes-Hub/lib/**'
              - 'Notes-Hub/test/**'
              - 'Notes-Hub/pubspec.yaml'
              - '.github/workflows/**'
              - 'scripts/**'

  static-analysis:
    name: Static Analysis
    needs: check-changes
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'
          cache: true
      - name: Flutter Pub Get
        working-directory: Notes-Hub
        run: flutter pub get
      - name: Check Formatting
        working-directory: Notes-Hub
        run: dart format --output=none --set-exit-if-changed .
      - name: Dependency Audit
        run: dart scripts/audit_dependencies.dart
      - name: License Audit
        run: dart scripts/audit_licenses.dart > license_audit.txt 2>&1 || (cat license_audit.txt && exit 1)
      - name: Run Flutter Analyzer
        working-directory: Notes-Hub
        run: flutter analyze --no-fatal-infos
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@v3.82.2
      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-results
          path: license_audit.txt
          retention-days: 1

  functional-tests:
    name: Functional Tests
    needs: check-changes
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'
          cache: true
      - name: Flutter Pub Get
        working-directory: Notes-Hub
        run: flutter pub get
      - name: Cache build_runner
        uses: actions/cache@v4
        with:
          path: Notes-Hub/.dart_tool/build
          key: ${{ runner.os }}-build-runner-${{ hashFiles('Notes-Hub/pubspec.lock') }}
      - name: Generate Mocks
        working-directory: Notes-Hub
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Run Tests
        working-directory: Notes-Hub
        run: flutter test --coverage
      - name: Calculate coverage
        run: dart scripts/calculate_coverage.dart Notes-Hub/coverage/lcov.info ${{ inputs.min_coverage }}
      - name: Upload lcov artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-lcov
          path: Notes-Hub/coverage/lcov.info
          retention-days: 1

  report-results:
    name: Report Results
    needs: [static-analysis, functional-tests]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
      - name: Download coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: Notes-Hub/coverage
      - name: Generate PR Summary
        run: |
          # Fetch baseline and scripts if needed
          git fetch origin coverage-data:coverage-data || echo "No baseline branch"
          git checkout coverage-data -- baseline_sizes.json || echo "No baseline file"
          dart scripts/generate_pr_summary.dart
      - name: Post PR Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pr_summary.md
