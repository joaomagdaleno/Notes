name: Quality Gate

on:
  workflow_call:

jobs:
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0
      - name: Install Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2
        with:
          flutter-version: '3.38.2'
          cache: true
      - name: Flutter Pub Get
        working-directory: universal_notes_flutter
        run: flutter pub get
      - name: Run Flutter Analyzer
        working-directory: universal_notes_flutter
        run: flutter analyze
      - name: Check for Outdated Packages
        working-directory: universal_notes_flutter
        run: dart pub outdated
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@df31a0e53a1efa49f2396699d51254455bb81868 # main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: Run Tests
        working-directory: universal_notes_flutter
        run: flutter test --coverage
      - name: Show coverage report
        run: |
          echo "--- Coverage Report (lcov.info) ---"
          cat universal_notes_flutter/coverage/lcov.info
          echo "-------------------------------------"
      - name: Calculate code coverage
        id: coverage
        run: |
          HIT=$(grep "^LH:" universal_notes_flutter/coverage/lcov.info | awk '{s+=$2} END {print s}' FS=":")
          FOUND=$(grep "^LF:" universal_notes_flutter/coverage/lcov.info | awk '{s+=$2} END {print s}' FS=":")
          if [ "$FOUND" -eq 0 ]; then
            COVERAGE="0.0"
          else
            COVERAGE=$(echo "scale=2; 100 * $HIT / $FOUND" | bc)
          fi
          echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT
      - name: Post coverage comment
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          message: "ðŸ“Š **Code Coverage:** `${{ steps.coverage.outputs.percentage }}%`"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Check code coverage
        run: |
          MIN_COVERAGE=80
          COVERAGE_PERCENTAGE=$(echo "${{ steps.coverage.outputs.percentage }}" | awk '{print int($1)}')
          if (( COVERAGE_PERCENTAGE < MIN_COVERAGE )); then
            echo "Error: Code coverage is ${{ steps.coverage.outputs.percentage }}%, which is below the required minimum of ${MIN_COVERAGE}%."
            exit 1
          fi
