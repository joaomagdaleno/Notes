name: Quality Gate

on:
  workflow_call:
    inputs:
      min_coverage:
        description: 'Minimum code coverage percentage'
        required: false
        default: '80'
        type: string

jobs:
  check-changes:
    name: Check Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Check changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'Notes-Hub/lib/**'
              - 'Notes-Hub/test/**'
              - 'Notes-Hub/pubspec.yaml'
              - '.github/workflows/**'
              - 'scripts/**'

  static-analysis:
    name: Static Analysis
    needs: check-changes
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'
          cache: true
      - name: Flutter Pub Get
        working-directory: Notes-Hub
        run: flutter pub get
      - name: Check Formatting
        working-directory: Notes-Hub
        run: dart format --output=none --set-exit-if-changed .
      - name: Dependency Audit
        run: dart scripts/audit_dependencies.dart
      - name: License Audit
        run: dart scripts/audit_licenses.dart > license_audit.txt 2>&1 || (cat license_audit.txt && exit 1)
      - name: Asset Audit
        run: dart scripts/audit_assets.dart
      - name: Complexity Audit
        run: dart scripts/calculate_complexity.dart
      - name: Check Updates
        run: dart scripts/check_updates.dart
      - name: Toolchain Guard
        run: dart scripts/hermes_doctor.dart
      - name: Generate CI Map
        run: dart scripts/generate_ci_map.dart
      - name: Dependency Usage Audit
        run: dart scripts/audit_dependency_usage.dart
      - name: Secret Expiry Watchdog
        run: dart scripts/secret_expiry_watchdog.dart
      - name: Governance Audit
        run: dart scripts/audit_workflows.dart
      - name: Platform Parity Audit
        run: dart scripts/audit_platform_parity.dart
      - name: I18n Guard
        run: dart scripts/audit_i18n.dart
      - name: Security Vulnerability Audit
        run: dart scripts/audit_vulnerabilities.dart
      - name: Environment Sync Check
        run: dart scripts/audit_env_sync.dart
      - name: Performance Guard
        run: dart scripts/audit_performance.dart
      - name: Architecture Guard
        run: dart scripts/audit_architecture.dart
      - name: Dead Code Audit
        run: dart scripts/audit_dead_code.dart
      - name: Environment Smoke Test
        run: dart scripts/smoke_test_env.dart
      - name: Git Hygiene Audit
        run: dart scripts/audit_git_hygiene.dart
      - name: Asset Fidelity Guard
        run: dart scripts/audit_asset_fidelity.dart
      - name: Design System Audit
        run: dart scripts/audit_design_system.dart
      - name: Test Stability Audit
        run: dart scripts/audit_test_stability.dart
      - name: Code Economy Auditor
        run: dart scripts/calculate_code_economy.dart
      - name: Asset Efficiency Audit
        run: dart scripts/audit_asset_size.dart
      - name: License Compliance
        run: dart scripts/audit_licenses.dart
      - name: Generate Governance Manifest
        run: dart scripts/generate_governance_manifest.dart
      - name: Generate Release Notes
        run: dart scripts/generate_release_notes.dart
      - name: Run Flutter Analyzer
        working-directory: Notes-Hub
        run: flutter analyze --no-fatal-infos
      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@v3.82.2
      - name: Upload Analysis Results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: analysis-results
          path: |
            license_audit.txt
            dependency_updates.md
            CI_MAP.md
            complexity_report.json
          retention-days: 1

  functional-tests:
    name: Functional Tests
    needs: check-changes
    if: needs.check-changes.outputs.code == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'
          cache: true
      - name: Flutter Pub Get
        working-directory: Notes-Hub
        run: flutter pub get
      - name: Cache build_runner
        uses: actions/cache@v5
        with:
          path: Notes-Hub/.dart_tool/build
          key: ${{ runner.os }}-build-runner-${{ hashFiles('Notes-Hub/pubspec.lock') }}
      - name: Generate Mocks
        working-directory: Notes-Hub
        run: flutter pub run build_runner build --delete-conflicting-outputs
      - name: Run Tests
        working-directory: Notes-Hub
        run: flutter test --coverage
      - name: Calculate coverage
        run: dart scripts/calculate_coverage.dart Notes-Hub/coverage/lcov.info ${{ inputs.min_coverage }}
      - name: Upload lcov artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-lcov
          path: Notes-Hub/coverage/lcov.info
          retention-days: 1

  report-results:
    name: Report Results
    needs: [static-analysis, functional-tests]
    if: always() && github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Download Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: analysis-results
      - name: Download coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-lcov
          path: Notes-Hub/coverage
      - name: Generate PR Summary
        run: |
          # Fetch baseline and scripts if needed
          git fetch origin coverage-data:coverage-data || echo "No baseline branch"
          git checkout coverage-data -- baseline_sizes.json || echo "No baseline file"
          dart scripts/calculate_impact_score.dart
          dart scripts/generate_pr_summary.dart
      - name: Collect Pulse Metrics
        run: dart scripts/collect_metrics.dart
      - name: Dependency Weight Analysis
        run: dart scripts/calculate_dependency_weight.dart
      - name: Generate Health Dashboard
        run: dart scripts/generate_health_dashboard.dart
      - name: Generate Visual Telemetry
        run: dart scripts/generate_visual_telemetry.dart
      - name: Upload Health Dashboard
        uses: actions/upload-artifact@v6
        with:
          name: hermes-health-pulse
          path: |
            hermes_health.html
            VISUAL_TELEMETRY.md
            RELEASE_NOTES.md
            GOVERNANCE_MANIFEST.md
            LICENSE_COMPLIANCE.md
      - name: Post PR Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: pr_summary.md
